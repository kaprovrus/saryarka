const QUEUE_SHEET_ID = '1zvb5y6j42EtGeJ9YXgBlPUNcBLXLw8_tG3w2H0qOROg';
const PROCESSED_SHEET_ID = '1_I_9ydPf4sUFSMK2DJNuhICiJ44QxU_gsWLX5EsYAOM';
const SHEET_QUEUE = 'sh';
const SHEET_PROCESSED = 'Приглашённые';
const SHEET_AUTH = 'password';

const SMSC_LOGIN = 'Shipudim';
const SMSC_PASSWORD = 'Dbrq3qcf';

function doGet(e) {
  if (!isAuthorized(e)) {
    return ContentService.createTextOutput(JSON.stringify({ authorized: false }));
  }

  const queueSheet = SpreadsheetApp.openById(QUEUE_SHEET_ID).getSheetByName(SHEET_QUEUE);
  const processedSheet = SpreadsheetApp.openById(PROCESSED_SHEET_ID).getSheetByName(SHEET_PROCESSED);

  const queueData = queueSheet.getDataRange().getValues().slice(1);
  const invitedData = processedSheet.getDataRange().getValues().slice(1);

  const today = new Date();
  const todayStr = formatDate(today);

  const queue = queueData
    .map((row, i) => ({
      rawIndex: i,
      name: row[1],
      phone: row[2],
      count: row[3],
      time: row[0],
      lang: row[4] || 'Русский'
    }))
    .filter(guest => formatDate(new Date(guest.time)) === todayStr);

  const invited = invitedData
    .map(row => ({
      name: row[1],
      phone: row[2],
      count: row[3],
      invitedAt: row[4],
      lang: row[5] || 'Русский'
    }))
    .filter(guest => formatDate(new Date(guest.invitedAt)) === todayStr);

  return ContentService.createTextOutput(JSON.stringify({ authorized: true, queue, invited }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  if (!isAuthorized(e)) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Unauthorized' }));
  }

  try {
    const index = parseInt(e.parameter.index);
    const queueSheet = SpreadsheetApp.openById(QUEUE_SHEET_ID).getSheetByName(SHEET_QUEUE);
    const processedSheet = SpreadsheetApp.openById(PROCESSED_SHEET_ID).getSheetByName(SHEET_PROCESSED);
    const data = queueSheet.getDataRange().getValues();

    const row = data[index + 1];
    const [recordTime, name, phone, count, lang] = row;
    const inviteTime = new Date();

    const message = getMessageForLanguage(lang);
    const url = `https://smsc.kz/sys/send.php?login=${SMSC_LOGIN}&psw=${SMSC_PASSWORD}&phones=${phone}&mes=${encodeURIComponent(message)}`;
    UrlFetchApp.fetch(url);

    processedSheet.appendRow([recordTime, name, phone, count, inviteTime, lang]);
    queueSheet.deleteRow(index + 2);

    return ContentService.createTextOutput(JSON.stringify({ success: true }));
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: err.message
    }));
  }
}

function isAuthorized(e) {
  const login = e.parameter.login;
  const password = e.parameter.password;
  if (!login || !password) return false;

  const sha1 = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_1, password)
    .map(b => ('0' + (b & 0xFF).toString(16)).slice(-2))
    .join('');

  const sheet = SpreadsheetApp.openById(PROCESSED_SHEET_ID).getSheetByName(SHEET_AUTH);
  const rows = sheet.getDataRange().getValues().slice(1); // без заголовка

  return rows.some(([storedLogin, storedHash]) => {
    return storedLogin === login && storedHash === sha1;
  });
}

function formatDate(date) {
  return Utilities.formatDate(date, Session.getScriptTimeZone(), "yyyy-MM-dd");
}

function getMessageForLanguage(lang) {
  switch ((lang || '').toLowerCase()) {
    case 'қазақша':
    case 'kazakh':
      return `Shupudim Сары-Арқа. Құрметті қонағымыз! Сіздің үстеліңіз дайын. Келуіңізді күтеміз!`;
    case 'english':
      return `Shupudim Sary-Arka. Dear guest! Your table is ready. We look forward to seeing you!`;
    default:
      return `Shupudim Сары-Арка. Здравствуйте, уважаемый гость! Ваш столик готов. Ждём вас!`;
  }
}
