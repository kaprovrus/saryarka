
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Очередь гостей</title>
<style>
:root {
    --primary-color: #1e3a8a;
    --success-color: #28a745;
    --danger-color: #d9534f;
    --light-bg: #f4f4f4;
    --white: #fff;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: Arial, sans-serif; padding: 20px; background: var(--light-bg); }
h2 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); margin-top: 30px; padding-bottom: 5px; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: var(--white); border-radius: 6px; overflow: hidden; }
th, td { padding: 12px; border-bottom: 1px solid #ddd; }
th { background: var(--primary-color); color: var(--white); }
tr:nth-child(even) { background: #f9f9f9; }
button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; }
button:hover:not(:disabled) { opacity: 0.85; }
button:disabled { background: #ccc; cursor: not-allowed; }
.timer { font-weight: bold; color: var(--danger-color); }
.expired { background: #f8d7da !important; }
.arrived { background: #d4edda !important; }
#login-section, #main-section { background: var(--white); padding: 20px; border-radius: 8px; max-width: 900px; margin: auto; }
#login-error { color: var(--danger-color); margin-top: 10px; }
</style>
</head>
<body>

<!-- Авторизация -->
<div id="login-section">
    <h2>Вход</h2>
    <input id="login" type="text" placeholder="Логин"><br><br>
    <input id="password" type="password" placeholder="Пароль"><br><br>
    <button onclick="handleLogin()">Войти</button>
    <p id="login-error"></p>
</div>

<!-- Основной экран -->
<div id="main-section" style="display:none;">
    <div style="text-align:right;">
        <button onclick="handleLogout()" style="background:var(--danger-color);color:#fff;">Выйти</button>
    </div>

    <h2>Гости в очереди</h2>
    <table id="queue-table">
        <thead>
            <tr>
                <th>Имя</th>
                <th>Телефон</th>
                <th>Кол-во</th>
                <th>Время</th>
                <th>Зал</th>
                <th>Номер стола</th>
                <th>Действие</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
<h1>Отображаются только гости с сегодняшней датой за статистикой посещаемости обращаться к администратору сайта</h1>
    <h2>Приглашённые гости</h2>
    <table id="invited-table">
        <thead>
            <tr>
                <th>Имя</th>
                <th>Телефон</th>
                <th>Кол-во</th>
                <th>Приглашён в</th>
                <th>Зал</th>
                <th>Номер стола</th>
                <th>Осталось</th>
                <th>Действие</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyibgUPgTozZCM4xV7wuFkdM98ILAsX2Ku-AaDZn3qYV5LdwmXb60UDbvggy_ACvYzX/exec';
let activeTimers = [];
const AUTO_LOGOUT_MS = 60 * 60 * 1000;
let logoutTimer;

function getAuthParams() {
    return { login: localStorage.getItem('login'), password: localStorage.getItem('password') };
}
function formatDate(date) {
    return new Date(date).toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' });
}
function formatTime(sec) {
    return sec <= 0 ? '00:00' : `${String(Math.floor(sec / 60)).padStart(2,'0')}:${String(sec % 60).padStart(2,'0')}`;
}
function resetLogoutTimer() {
    clearTimeout(logoutTimer);
    logoutTimer = setTimeout(handleLogout, AUTO_LOGOUT_MS);
}

async function handleLogin() {
    const login = document.getElementById('login').value.trim();
    const password = document.getElementById('password').value.trim();
    const res = await fetch(`${API_URL}?login=${encodeURIComponent(login)}&password=${encodeURIComponent(password)}`);
    const data = await res.json();
    if (!data.authorized) {
        document.getElementById('login-error').textContent = "Неверный логин или пароль";
        return;
    }
    localStorage.setItem('login', login);
    localStorage.setItem('password', password);
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('main-section').style.display = '';
    resetLogoutTimer();
    loadGuests();
}

async function loadGuests() {
    activeTimers.forEach(clearInterval);
    activeTimers = [];
    const { login, password } = getAuthParams();
    const res = await fetch(`${API_URL}?login=${encodeURIComponent(login)}&password=${encodeURIComponent(password)}`);
    const data = await res.json();
    if (!data.authorized) return handleLogout();

    const queueBody = document.querySelector("#queue-table tbody");
    const invitedBody = document.querySelector("#invited-table tbody");
    queueBody.innerHTML = '';
    invitedBody.innerHTML = '';

    data.queue.forEach((guest) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${guest.name || ''}</td>
            <td>${guest.phone || ''}</td>
            <td>${guest.count || ''}</td>
            <td>${formatDate(guest.time)}</td>
            <td>${guest.hall || ''}</td>
            <td><input type="text" placeholder="№"></td>
            <td><button style="background:var(--success-color);color:#fff;" onclick="invite(this, '${guest.name}', '${guest.lang || ''}', '${guest.phone}', '${guest.hall || ''}')">Пригласить</button></td>
        `;
        queueBody.appendChild(tr);
    });

    data.invited.forEach(guest => {
        const tr = document.createElement('tr');
        const invitedAt = new Date(guest.invitedAt);
        const secLeft = 600 - Math.floor((Date.now() - invitedAt) / 1000);
        tr.className = guest.isArrived ? 'arrived' : (secLeft <= 0 ? 'expired' : '');
        tr.innerHTML = `
            <td>${guest.name || ''}</td>
            <td>${guest.phone || ''}</td>
            <td>${guest.count || ''}</td>
            <td>${formatDate(guest.invitedAt)}</td>
            <td>${guest.hall || ''}</td>
            <td>${guest.tableNumber || ''}</td>
            <td class="timer">${guest.isArrived ? 'Пришёл' : (secLeft > 0 ? formatTime(secLeft) : 'Время вышло')}</td>
            <td>${guest.isArrived ? '<span>Пришёл</span>' : `<button onclick="markArrived(this, '${guest.phone}', '${guest.tableNumber || ''}')">Пришёл</button>`}</td>
        `;
        invitedBody.appendChild(tr);
        if (secLeft > 0 && !guest.isArrived) activeTimers.push(startTimer(tr, secLeft));
    });
}

function startTimer(row, secLeft) {
    const timerCell = row.querySelector('.timer');
    const interval = setInterval(() => {
        secLeft--;
        if (row.classList.contains('arrived')) return clearInterval(interval);
        if (secLeft <= 0) {
            clearInterval(interval);
            timerCell.textContent = "Время вышло";
            row.classList.add("expired");
        } else {
            timerCell.textContent = formatTime(secLeft);
        }
    }, 1000);
    return interval;
}

async function invite(button, name, lang, phone, hall) {
    const tableNumber = button.closest('tr').querySelector('input').value.trim();
    if (!tableNumber) return alert("Введите номер стола!");
    if (!confirm(`Пригласить ${name} на стол №${tableNumber}?`)) return;
    button.disabled = true;
    const { login, password } = getAuthParams();
    const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ action: 'invite', login, password, tableNumber, name, lang, phone, hall })
    });
    const result = await res.json();
    if (result.success) {
        alert("Приглашение отправлено ✅");
        loadGuests();
    } else {
        alert("Ошибка: " + (result.error || "Неизвестная"));
        button.disabled = false;
    }
}

async function markArrived(button, phone, tableNumber) {
    const { login, password } = getAuthParams();
    const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ action: 'arrived', phone, tableNumber, login, password })
    });
    const result = await res.json();
    if (result.success) loadGuests();
    else alert("Ошибка: " + (result.error || "Неизвестная"));
}

function handleLogout() {
    localStorage.clear();
    location.reload();
}

setInterval(() => {
    if (document.getElementById('main-section').style.display !== 'none') loadGuests();
}, 20000);

['click', 'mousemove', 'keydown', 'touchstart'].forEach(evt => document.addEventListener(evt, resetLogoutTimer));

if (localStorage.getItem('login')) {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('main-section').style.display = '';
    loadGuests();
}
</script>
</body>
</html>
